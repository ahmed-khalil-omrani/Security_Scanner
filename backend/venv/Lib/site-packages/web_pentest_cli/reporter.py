"""
Report generation module - JSON, Markdown, and HTML output
"""

import json
import logging
from typing import Dict, List, Optional
from datetime import datetime

logger = logging.getLogger(__name__)


class Reporter:
    """
    Generate security scan reports in multiple formats.
    """
    
    def __init__(self):
        """Initialize reporter."""
        self.report_data = None
    
    def generate_json(self, scan_results: Dict, output_file: Optional[str] = None) -> str:
        """
        Generate JSON report.
        
        Args:
            scan_results: Scan results dictionary
            output_file: Optional file path to save report
            
        Returns:
            JSON string
        """
        json_str = json.dumps(scan_results, indent=2, default=str)
        
        if output_file:
            with open(output_file, 'w', encoding='utf-8') as f:
                f.write(json_str)
            logger.info(f"JSON report saved to: {output_file}")
        
        return json_str
    
    def generate_markdown(self, scan_results: Dict, output_file: Optional[str] = None) -> str:
        """
        Generate Markdown report.
        
        Args:
            scan_results: Scan results dictionary
            output_file: Optional file path to save report
            
        Returns:
            Markdown string
        """
        lines = []
        
        # Header
        lines.append("# Web Security Scan Report")
        lines.append("")
        lines.append(f"**Generated by:** ShieldScan v1.0")
        lines.append(f"**Scan ID:** {scan_results.get('scan_id', 'N/A')}")
        lines.append(f"**Target:** {scan_results.get('target_url', 'N/A')}")
        lines.append(f"**Scan Mode:** {scan_results.get('mode', 'N/A').upper()}")
        lines.append(f"**Start Time:** {scan_results.get('start_time', 'N/A')}")
        lines.append(f"**Duration:** {scan_results.get('statistics', {}).get('scan_duration_seconds', 0):.2f} seconds")
        lines.append(f"**Status:** {scan_results.get('status', 'N/A').upper()}")
        lines.append("")
        
        # Executive Summary
        lines.append("## Executive Summary")
        lines.append("")
        stats = scan_results.get('statistics', {})
        severity = stats.get('severity_breakdown', {})
        
        total_vulns = stats.get('total_vulnerabilities', 0)
        lines.append(f"**Total Vulnerabilities Found:** {total_vulns}")
        lines.append("")
        
        if total_vulns > 0:
            lines.append("### Severity Breakdown")
            lines.append("")
            lines.append("| Severity | Count |")
            lines.append("|----------|-------|")
            for sev in ['critical', 'high', 'medium', 'low', 'info']:
                count = severity.get(sev, 0)
                if count > 0:
                    lines.append(f"| {sev.upper()} | {count} |")
            lines.append("")
        
        # Reconnaissance Summary
        recon = scan_results.get('reconnaissance', {})
        if recon:
            lines.append("## Reconnaissance Summary")
            lines.append("")
            lines.append(f"- **URLs Discovered:** {recon.get('discovered_urls_count', 0)}")
            lines.append(f"- **Forms Found:** {recon.get('forms_count', 0)}")
            lines.append(f"- **Input Points:** {recon.get('input_points_count', 0)}")
            
            techs = recon.get('technologies', [])
            if techs:
                lines.append(f"- **Technologies Detected:** {', '.join(techs)}")
            lines.append("")
        
        # Vulnerabilities
        vulns = scan_results.get('vulnerabilities', [])
        if vulns:
            lines.append("## Vulnerabilities")
            lines.append("")
            
            # Group by severity
            by_severity = {}
            for vuln in vulns:
                sev = vuln.get('severity', 'unknown').upper()
                if sev not in by_severity:
                    by_severity[sev] = []
                by_severity[sev].append(vuln)
            
            for sev in ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO']:
                if sev in by_severity:
                    lines.append(f"### {sev} Severity")
                    lines.append("")
                    
                    for vuln in by_severity[sev]:
                        lines.append(f"#### {vuln.get('name', 'Unknown Vulnerability')}")
                        lines.append("")
                        lines.append(f"- **Vulnerability ID:** {vuln.get('vuln_id', 'N/A')}")
                        lines.append(f"- **Confidence:** {vuln.get('confidence', 'N/A').upper()}")
                        if vuln.get('url'):
                            lines.append(f"- **URL:** {vuln['url']}")
                        lines.append(f"- **Description:** {vuln.get('description', 'N/A')}")
                        lines.append(f"- **Evidence:** `{vuln.get('evidence', 'N/A')}`")
                        lines.append(f"- **Remediation:** {vuln.get('remediation', 'N/A')}")
                        
                        refs = vuln.get('references', [])
                        if refs:
                            lines.append(f"- **References:**")
                            for ref in refs:
                                lines.append(f"  - {ref}")
                        lines.append("")
        
        # Recommendations
        if vulns:
            lines.append("## Recommendations")
            lines.append("")
            lines.append("### Immediate Actions")
            lines.append("")
            
            critical_high = [v for v in vulns if v.get('severity', '').upper() in ['CRITICAL', 'HIGH']]
            if critical_high:
                for vuln in critical_high[:5]:
                    lines.append(f"1. **{vuln.get('name')}:** {vuln.get('remediation', 'Review and fix')}")
            else:
                lines.append("- No critical or high severity issues found.")
            
            lines.append("")
            lines.append("### General Best Practices")
            lines.append("")
            lines.append("- Implement comprehensive input validation and output encoding")
            lines.append("- Enable all recommended security headers")
            lines.append("- Use HTTPS everywhere with HSTS enabled")
            lines.append("- Regularly update and patch all software components")
            lines.append("- Implement security monitoring and logging")
            lines.append("- Conduct regular security assessments")
            lines.append("")
        
        # Footer
        lines.append("---")
        lines.append("")
        lines.append("**Note:** This report is generated by an automated tool. "
                    "Manual verification is recommended for all findings.")
        lines.append("")
        lines.append("**Legal Notice:** Use this tool only on systems you own or have "
                    "explicit authorization to test.")
        
        markdown = "\n".join(lines)
        
        if output_file:
            with open(output_file, 'w', encoding='utf-8') as f:
                f.write(markdown)
            logger.info(f"Markdown report saved to: {output_file}")
        
        return markdown
    
    def generate_html(self, scan_results: Dict, output_file: Optional[str] = None) -> str:
        """
        Generate HTML report with deduplicated vulnerabilities and security threats overview.

        Args:
            scan_results: Scan results dictionary
            output_file: Optional file path to save report

        Returns:
            HTML string
        """
        stats = scan_results.get('statistics', {})
        severity = stats.get('severity_breakdown', {})
        vulns = scan_results.get('vulnerabilities', [])

        # ‚úÖ DEDUPLICATE vulnerabilities by vuln_id
        unique_vulns = {}
        for vuln in vulns:
            vuln_id = vuln.get('vuln_id', '')
            if vuln_id not in unique_vulns:
                # First occurrence
                unique_vulns[vuln_id] = vuln
                unique_vulns[vuln_id]['affected_urls'] = [vuln.get('url', 'N/A')]
            else:
                # Add URL to affected_urls list
                url = vuln.get('url', 'N/A')
                if url not in unique_vulns[vuln_id]['affected_urls']:
                    unique_vulns[vuln_id]['affected_urls'].append(url)

        # Convert back to list
        deduplicated_vulns = list(unique_vulns.values())

        # Calculate unique severity breakdown for display
        unique_severity = {'critical': 0, 'high': 0, 'medium': 0, 'low': 0, 'info': 0}
        for vuln in deduplicated_vulns:
            sev = vuln.get('severity', 'info').lower()
            if sev in unique_severity:
                unique_severity[sev] += 1

        # ‚úÖ FIX: Calculate actual total findings from deduplicated vulnerabilities
        actual_total_findings = sum(len(vuln.get('affected_urls', [])) for vuln in deduplicated_vulns)

        # üÜï THREAT CATEGORIES MAPPING
        threat_categories = {
            'xss': {'name': 'XSS (Cross-Site Scripting)', 'icon': 'üî¥', 'keywords': ['xss', 'reflected', 'stored', 'dom']},
            'injection': {'name': 'SQL Injection & Injection Attacks', 'icon': 'üíâ', 'keywords': ['sql', 'injection', 'command', 'ldap', 'xml']},
            'mitm': {'name': 'Man-in-the-Middle (MITM)', 'icon': 'üîì', 'keywords': ['hsts', 'ssl', 'tls', 'insecure', 'transport']},
            'csrf': {'name': 'CSRF (Cross-Site Request Forgery)', 'icon': 'üö´', 'keywords': ['csrf', 'forgery', 'request']},
            'clickjacking': {'name': 'Clickjacking', 'icon': 'üëÜ', 'keywords': ['clickjack', 'frame', 'x-frame']},
            'cors': {'name': 'CORS Misconfiguration', 'icon': 'üîÄ', 'keywords': ['cors', 'cross-origin']},
            'privacy': {'name': 'Privacy & Information Disclosure', 'icon': 'üëÅÔ∏è', 'keywords': ['disclosure', 'directory', 'listing', 'sensitive', 'referrer']},
            'csp': {'name': 'Content Security Policy', 'icon': 'üõ°Ô∏è', 'keywords': ['csp', 'content-security']},
            'auth': {'name': 'Authentication & Session Issues', 'icon': 'üîë', 'keywords': ['cookie', 'session', 'auth', 'secure', 'httponly']},
            'misc': {'name': 'Miscellaneous Security Issues', 'icon': '‚ö†Ô∏è', 'keywords': ['permission', 'policy', 'header', 'options']},
        }

        # üÜï DETECT WHICH THREATS ARE PRESENT
        detected_threats = set()
        for vuln in deduplicated_vulns:
            vuln_name = vuln.get('name', '').lower()
            vuln_desc = vuln.get('description', '').lower()
            combined = f"{vuln_name} {vuln_desc}"
            
            for threat_key, threat_info in threat_categories.items():
                for keyword in threat_info['keywords']:
                    if keyword.lower() in combined:
                        detected_threats.add(threat_key)
                        break

        html = f"""<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ShieldScan Report - {scan_results.get('target_url', 'N/A')}</title>
        <style>
            body {{
                font-family: Arial, sans-serif;
                line-height: 1.6;
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
                background-color: #f5f5f5;
            }}
            .header {{
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px;
                border-radius: 8px;
                margin-bottom: 30px;
            }}
            .header h1 {{
                margin: 0 0 10px 0;
            }}
            .header p {{
                margin: 5px 0;
            }}
            
            /* üÜï THREATS OVERVIEW SECTION */
            .threats-section {{
                background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
                color: white;
                padding: 30px;
                border-radius: 8px;
                margin-bottom: 30px;
                border-left: 5px solid #ef4444;
            }}
            .threats-section h2 {{
                margin: 0 0 20px 0;
                font-size: 24px;
                color: #fff;
                border-bottom: 2px solid #ef4444;
                padding-bottom: 10px;
            }}
            .threats-grid {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 15px;
                margin-top: 20px;
            }}
            .threat-card {{
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                padding: 15px;
                border-radius: 6px;
                transition: all 0.3s ease;
                cursor: pointer;
            }}
            .threat-card:hover {{
                background: rgba(255, 255, 255, 0.1);
                border-color: rgba(239, 68, 68, 0.5);
                transform: translateY(-2px);
            }}
            .threat-card.detected {{
                background: rgba(239, 68, 68, 0.1);
                border-color: #ef4444;
                box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
            }}
            .threat-icon {{
                font-size: 28px;
                margin-right: 10px;
            }}
            .threat-name {{
                font-weight: bold;
                font-size: 14px;
                display: flex;
                align-items: center;
            }}
            .threat-badge {{
                display: inline-block;
                background: #ef4444;
                color: white;
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 11px;
                margin-left: auto;
                font-weight: bold;
            }}
            
            .stats {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }}
            .stat-card {{
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }}
            .stat-card h3 {{
                margin: 0 0 10px 0;
                color: #666;
                font-size: 14px;
            }}
            .stat-card .value {{
                font-size: 32px;
                font-weight: bold;
                color: #333;
            }}
            .severity-critical {{ color: #dc3545; }}
            .severity-high {{ color: #fd7e14; }}
            .severity-medium {{ color: #ffc107; }}
            .severity-low {{ color: #28a745; }}
            .severity-info {{ color: #17a2b8; }}
            .vulnerability {{
                background: white;
                padding: 20px;
                margin-bottom: 20px;
                border-radius: 8px;
                border-left: 5px solid #ddd;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }}
            .vulnerability.critical {{ border-left-color: #dc3545; }}
            .vulnerability.high {{ border-left-color: #fd7e14; }}
            .vulnerability.medium {{ border-left-color: #ffc107; }}
            .vulnerability.low {{ border-left-color: #28a745; }}
            .vulnerability.info {{ border-left-color: #17a2b8; }}
            .vulnerability h3 {{
                margin: 0 0 10px 0;
                color: #333;
            }}
            .badge {{
                display: inline-block;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: bold;
                text-transform: uppercase;
                margin-right: 8px;
            }}
            .badge.critical {{ background: #dc3545; color: white; }}
            .badge.high {{ background: #fd7e14; color: white; }}
            .badge.medium {{ background: #ffc107; color: black; }}
            .badge.low {{ background: #28a745; color: white; }}
            .badge.info {{ background: #17a2b8; color: white; }}
            code {{
                background: #f8f9fa;
                padding: 2px 6px;
                border-radius: 3px;
                font-family: 'Courier New', monospace;
                word-break: break-all;
            }}
            .urls-list {{
                background: #f8f9fa;
                padding: 10px;
                border-radius: 4px;
                margin: 10px 0;
            }}
            .urls-list ul {{
                margin: 5px 0;
                padding-left: 20px;
            }}
            .urls-list li {{
                margin: 3px 0;
                font-size: 13px;
                color: #666;
            }}
            .url-count {{
                font-size: 12px;
                font-weight: bold;
                color: #667eea;
            }}
            h2 {{
                color: #333;
                border-bottom: 2px solid #667eea;
                padding-bottom: 10px;
            }}
            .section-title {{
                margin-top: 30px;
                margin-bottom: 15px;
                font-size: 18px;
                font-weight: bold;
                color: #333;
            }}
        </style>
    </head>
    <body>
        <div class="header">
            <h1>üõ°Ô∏è ShieldScan Security Report</h1>
            <p><strong>Target:</strong> {scan_results.get('target_url', 'N/A')}</p>
            <p><strong>Scan ID:</strong> {scan_results.get('scan_id', 'N/A')} | 
            <strong>Mode:</strong> {scan_results.get('mode', 'N/A').upper()} | 
            <strong>Duration:</strong> {stats.get('scan_duration_seconds', 0):.2f}s</p>
        </div>

        <!-- üÜï SECURITY THREATS OVERVIEW -->
        <div class="threats-section">
            <h2>‚ö†Ô∏è Detected Security Threats</h2>
            <div class="threats-grid">
    """

        # Add threat cards
        for threat_key, threat_info in threat_categories.items():
            is_detected = threat_key in detected_threats
            detected_class = 'detected' if is_detected else ''
            badge_html = '<span class="threat-badge">DETECTED</span>' if is_detected else ''
            
            html += f"""
                <div class="threat-card {detected_class}">
                    <div class="threat-name">
                        <span class="threat-icon">{threat_info['icon']}</span>
                        <span>{threat_info['name']}</span>
                        {badge_html}
                    </div>
                </div>
    """

        html += """
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>Total Findings</h3>
                <div class="value">{actual_total}</div>
            </div>
            <div class="stat-card">
                <h3>Unique Issues</h3>
                <div class="value">{unique}</div>
            </div>
            <div class="stat-card">
                <h3>Critical</h3>
                <div class="value severity-critical">{critical}</div>
            </div>
            <div class="stat-card">
                <h3>High</h3>
                <div class="value severity-high">{high}</div>
            </div>
            <div class="stat-card">
                <h3>Medium</h3>
                <div class="value severity-medium">{medium}</div>
            </div>
            <div class="stat-card">
                <h3>Low</h3>
                <div class="value severity-low">{low}</div>
            </div>
        </div>

        <h2>Vulnerabilities</h2>
    """.format(
            actual_total=actual_total_findings,
            unique=len(deduplicated_vulns),
            critical=unique_severity.get('critical', 0),
            high=unique_severity.get('high', 0),
            medium=unique_severity.get('medium', 0),
            low=unique_severity.get('low', 0)
        )

        if deduplicated_vulns:
            # Group by severity
            by_severity = {}
            for vuln in deduplicated_vulns:
                sev = vuln.get('severity', 'unknown').upper()
                if sev not in by_severity:
                    by_severity[sev] = []
                by_severity[sev].append(vuln)

            # Display in severity order
            severity_order = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO']
            
            for sev in severity_order:
                if sev in by_severity:
                    html += f'<div class="section-title">{sev} Severity ({len(by_severity[sev])})</div>'
                    
                    for vuln in by_severity[sev]:
                        sev_lower = sev.lower()
                        affected_urls = vuln.get('affected_urls', [])
                        
                        html += f"""
        <div class="vulnerability {sev_lower}">
            <h3>{vuln.get('name', 'Unknown')}</h3>
            <p>
                <span class="badge {sev_lower}">{sev_lower}</span>
                <span class="badge info">{vuln.get('confidence', 'N/A')} confidence</span>
                <span class="url-count">Affects {len(affected_urls)} URL(s)</span>
            </p>
            
            <p><strong>Description:</strong> {vuln.get('description', 'N/A')}</p>
            <p><strong>Evidence:</strong> <code>{vuln.get('evidence', 'N/A')}</code></p>
            <p><strong>Remediation:</strong> {vuln.get('remediation', 'N/A')}</p>
    """
                        
                        # ‚úÖ Show affected URLs
                        if affected_urls:
                            html += '<div class="urls-list">'
                            html += f'<strong>Affected URLs ({len(affected_urls)}):</strong>'
                            html += '<ul>'
                            
                            # Show first 10, then summary
                            for url in affected_urls[:10]:
                                html += f'<li>{url}</li>'
                            
                            if len(affected_urls) > 10:
                                html += f'<li><em>... and {len(affected_urls) - 10} more</em></li>'
                            
                            html += '</ul></div>'
                        
                        html += """
        </div>
    """
        else:
            html += "<p>‚úÖ No vulnerabilities detected.</p>"

        html += """
        <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 14px;">
            <p><strong>Note:</strong> This report is generated by an automated tool. Manual verification is recommended.</p>
            <p><strong>Legal:</strong> Use only on systems you own or have authorization to test.</p>
            <p><strong>Report Details:</strong> Vulnerabilities are deduplicated by issue type. Total findings includes all instances across scanned URLs.</p>
        </footer>
    </body>
    </html>
    """

        if output_file:
            with open(output_file, 'w', encoding='utf-8') as f:
                f.write(html)
            logger.info(f"HTML report saved to: {output_file}")

        return html

    
       
    def generate_console_summary(self, scan_results: Dict) -> str:
        """
        Generate console-friendly summary.
        
        Args:
            scan_results: Scan results dictionary
            
        Returns:
            Formatted string for console output
        """
        lines = []
        lines.append("")
        lines.append("=" * 80)
        lines.append("  SCAN SUMMARY")
        lines.append("=" * 80)
        
        stats = scan_results.get('statistics', {})
        severity = stats.get('severity_breakdown', {})
        
        lines.append(f"Target:     {scan_results.get('target_url', 'N/A')}")
        lines.append(f"Scan ID:    {scan_results.get('scan_id', 'N/A')}")
        lines.append(f"Duration:   {stats.get('scan_duration_seconds', 0):.2f} seconds")
        lines.append(f"Requests:   {stats.get('http_requests', 0)}")
        lines.append("")
        lines.append(f"Total Vulnerabilities: {stats.get('total_vulnerabilities', 0)}")
        lines.append("")
        
        if severity:
            lines.append("Severity Breakdown:")
            for sev in ['critical', 'high', 'medium', 'low', 'info']:
                count = severity.get(sev, 0)
                if count > 0:
                    lines.append(f"  {sev.upper()}: {count}")
        
        lines.append("=" * 80)
        
        return "\n".join(lines)