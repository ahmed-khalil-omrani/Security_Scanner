"""
Command-line interface for ShieldScan
"""

import argparse
import logging
import sys
import os
from typing import Optional, List

from .logo import get_logo, get_version
from .scanner import Scanner
from .reporter import Reporter
from .utils import parse_consent_file, is_valid_url, create_safe_filename


def setup_logging(verbosity: int) -> None:
    """Configure logging based on verbosity level."""
    level_map = {
        0: logging.WARNING,
        1: logging.INFO,
        2: logging.DEBUG
    }

    level = level_map.get(verbosity, logging.INFO)

    # Console handler
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setLevel(level)
    console_formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )
    console_handler.setFormatter(console_formatter)

    # File handler
    from logging.handlers import RotatingFileHandler

    log_dir = 'logs'
    os.makedirs(log_dir, exist_ok=True)

    file_handler = RotatingFileHandler(
        os.path.join(log_dir, 'shieldscan.log'),
        maxBytes=10*1024*1024,
        backupCount=5
    )
    file_handler.setLevel(logging.DEBUG)
    file_handler.setFormatter(logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    ))

    root_logger = logging.getLogger()
    root_logger.setLevel(logging.DEBUG)
    root_logger.addHandler(console_handler)
    root_logger.addHandler(file_handler)


def validate_consent(consent_file: Optional[str], mode: str, target_url: str) -> Optional[dict]:
    """Validate consent for active scanning."""
    if mode == 'active':
        if not consent_file:
            print("\nâŒ ERROR: Active mode requires explicit consent.")
            print("   Please provide a consent file using --consent-file\n")
            sys.exit(1)

        try:
            consent_info = parse_consent_file(consent_file)

            if consent_info['target'].lower() not in target_url.lower():
                print(f"\nâŒ ERROR: Target URL does not match consent file\n")
                sys.exit(1)

            print("âœ“ Consent validated")
            return consent_info

        except Exception as e:
            print(f"\nâŒ ERROR: Consent validation failed: {e}\n")
            sys.exit(1)

    return None


def load_targets_from_file(filepath: str) -> List[str]:
    """Load target URLs from file."""
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            urls = [line.strip() for line in f if line.strip() and not line.startswith('#')]
        return urls
    except Exception as e:
        print(f"\nâŒ ERROR: Failed to load targets: {e}\n")
        sys.exit(1)


def scan_command(args) -> None:
    """Execute scan command."""
    if not args.no_logo:
        print(get_logo())

    setup_logging(args.verbosity)
    logger = logging.getLogger(__name__)

    # Get targets
    targets = []
    if args.target:
        targets = [args.target]
    elif args.target_file:
        targets = load_targets_from_file(args.target_file)
    else:
        print("\nâŒ ERROR: No target specified\n")
        sys.exit(1)

    for url in targets:
        if not is_valid_url(url):
            print(f"\nâŒ ERROR: Invalid URL: {url}\n")
            sys.exit(1)

    print(f"\nğŸ¯ Target(s): {len(targets)}")
    print(f"ğŸ”’ Mode: {args.mode.upper()}")
    print(f"âš¡ Rate limit: {args.throttle} req/s")

    consent_info = None
    if args.mode == 'active':
        consent_info = validate_consent(args.consent_file, args.mode, targets[0])

    if args.dry_run:
        print("\nğŸ” DRY RUN MODE\n")
        print("Planned checks:")
        print("  âœ“ Security Headers")
        print("  âœ“ Cookie Security")
        if args.mode == 'active':
            print("  âœ“ XSS & SQLi Detection")
        print("\nâœ“ Dry run complete\n")
        return

    scanner = Scanner(
        mode=args.mode,
        rate_limit=args.throttle,
        max_depth=args.max_depth,
        timeout=10
    )

    print("\nğŸš€ Starting scan...\n")

    if len(targets) == 1:
        results = scanner.scan(targets[0], consent_info)
        all_results = [results]
    else:
        all_results = scanner.scan_multiple(targets, consent_info)

    reporter = Reporter()

    for result in all_results:
        print(reporter.generate_console_summary(result))

        if args.output:
            output_base = args.output.rsplit('.', 1)[0]

            if args.format == 'json':
                reporter.generate_json(result, f"{output_base}.json")
            elif args.format == 'markdown':
                reporter.generate_markdown(result, f"{output_base}.md")
            elif args.format == 'html':
                reporter.generate_html(result, f"{output_base}.html")
            elif args.format == 'all':
                reporter.generate_json(result, f"{output_base}.json")
                reporter.generate_markdown(result, f"{output_base}.md")
                reporter.generate_html(result, f"{output_base}.html")

            print(f"\nğŸ“„ Report saved: {output_base}.{args.format}")

    print("\nâœ… Scan complete!\n")


def main():
    """Main entry point."""
    parser = argparse.ArgumentParser(
        description='ShieldScan - Professional Web Security Assessment Tool'
    )

    subparsers = parser.add_subparsers(dest='command', help='Commands')
    scan_parser = subparsers.add_parser('scan', help='Perform security scan')

    target_group = scan_parser.add_mutually_exclusive_group(required=True)
    target_group.add_argument('--target', type=str, help='Single target URL')
    target_group.add_argument('--target-file', type=str, help='File with URLs')

    scan_parser.add_argument('--mode', type=str, choices=['passive', 'active'], 
                            default='passive', help='Scanning mode')
    scan_parser.add_argument('--consent-file', type=str, help='Consent file path')
    scan_parser.add_argument('--output', type=str, help='Output file path')
    scan_parser.add_argument('--format', type=str, 
                            choices=['json', 'markdown', 'html', 'all'],
                            default='json', help='Output format')
    scan_parser.add_argument('--throttle', type=float, default=1.0, 
                            help='Requests per second')
    scan_parser.add_argument('--max-depth', type=int, default=2, 
                            help='Maximum crawl depth')
    scan_parser.add_argument('-v', '--verbosity', type=int, choices=[0, 1, 2],
                            default=1, help='Logging verbosity')
    scan_parser.add_argument('--dry-run', action='store_true', 
                            help='Show planned checks')
    scan_parser.add_argument('--no-logo', action='store_true', 
                            help='Suppress logo')

    args = parser.parse_args()

    if args.command == 'scan':
        scan_command(args)
    else:
        parser.print_help()


if __name__ == '__main__':
    main()

